<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zarządzanie mockupami etui</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
      }

      #file-input {
        display: none;
      }

      .nav-buttons {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .back-btn {
        padding: 10px 20px;
        background-color: #95a5a6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .back-btn:hover {
        background-color: #7f8c8d;
      }

      .requirements {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
      }

      .requirements h3 {
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .requirements ul {
        margin-left: 20px;
      }

      .requirements li {
        margin-bottom: 5px;
      }

      /* Styles for mockup gallery */
      .existing-mockups {
        margin-top: 30px;
        margin-bottom: 30px;
        position: relative;
      }

      .existing-mockups.dragover {
        outline: 2px dashed #3498db;
        outline-offset: 8px;
        background-color: rgba(52, 152, 219, 0.05);
      }

      .existing-mockups h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        text-align: center;
      }

      .mockup-gallery {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        min-height: 200px;
      }

      .mockup-item {
        position: relative;
        border: 3px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 1/1;
        background-color: white;
        display: flex;
        flex-direction: column;
      }

      .mockup-thumbnail {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        cursor: pointer;
      }

      .mockup-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .mockup-item.active {
        border: 3px solid #3498db;
      }

      .mockup-controls {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        background-color: #f8f9fa;
      }

      .mockup-number {
        font-weight: bold;
        color: #333;
        padding: 4px 8px;
      }

      .mockup-actions {
        display: flex;
        gap: 5px;
      }

      .action-btn {
        width: 26px;
        height: 26px;
        border-radius: 4px;
        border: none;
        background-color: #e0e0e0;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s;
      }

      .action-btn:hover {
        background-color: #d0d0d0;
      }

      .action-btn.delete {
        background-color: #e74c3c;
        color: white;
      }

      .action-btn.delete:hover {
        background-color: #c0392b;
      }

      /* Style for loading indicator */
      .loading-indicator {
        text-align: center;
        color: #666;
        margin: 20px 0;
      }

      .section-header {
        margin: 20px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .no-mockups {
        text-align: center;
        color: #999;
        padding: 40px;
      }

      .add-new-btn {
        margin-left: auto;
        margin-right: auto;
        display: block;
        margin-bottom: 30px;
        padding: 12px 24px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }

      .add-new-btn:hover {
        background-color: #2980b9;
      }

      .upload-indicator {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        display: none;
      }

      .upload-indicator-text {
        font-size: 24px;
        color: #333;
        margin-bottom: 15px;
      }

      .mockup-model {
        font-size: 12px;
        color: #666;
        flex: 1;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 0 5px;
      }

      .mockup-item {
        margin-bottom: 15px;
      }

      .model-header {
        background-color: #f1f1f1;
        padding: 8px 12px;
        margin-bottom: 10px;
        border-radius: 4px;
        font-weight: bold;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .mockup-gallery {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="nav-buttons">
        <a href="index.html" class="back-btn">← Powrót do edytora</a>
      </div>

      <h1>Zarządzanie mockupami etui</h1>

      <div class="requirements">
        <h3>Wymagania dla mockupów:</h3>
        <ul>
          <li>Format PNG z przezroczystym tłem</li>
          <li>
            Mockup powinien przedstawiać obrys telefonu z przezroczystą częścią
            w miejscu, gdzie będzie wstawiony obraz
          </li>
          <li>
            Zmiany w mockupach będą dostępne w edytorze po odświeżeniu strony
          </li>
        </ul>
      </div>

      <!-- Existing mockups section -->
      <div class="existing-mockups" id="existing-mockups">
        <div class="section-header">
          <h3>Istniejące mockupy</h3>
        </div>
        <div class="loading-indicator" id="loading-indicator">
          Wczytywanie dostępnych mockupów...
        </div>
        <div class="mockup-gallery" id="mockup-gallery">
          <!-- Mockupy zostaną dodane dynamicznie przez JavaScript -->
        </div>
        <div class="no-mockups" id="no-mockups" style="display: none">
          Nie znaleziono żadnych mockupów. Dodaj nowe mockupy, aby rozpocząć.
        </div>
        <div class="upload-indicator" id="upload-indicator">
          <div class="upload-indicator-text">Zapisywanie mockupów...</div>
        </div>
      </div>

      <!-- Button to add new mockups -->
      <div style="margin-bottom: 20px; text-align: center">
        <label
          for="mockup-model"
          style="display: block; margin-bottom: 8px; font-weight: bold"
          >Model telefonu:</label
        >
        <input
          type="text"
          id="mockup-model"
          list="models-list"
          placeholder="np. iPhone_14_Pro"
          style="
            width: 100%;
            max-width: 300px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
          "
        />
        <datalist id="models-list">
          <!-- Models will be dynamically loaded here -->
        </datalist>
        <p style="margin-top: 5px; color: #666; font-size: 13px">
          Wybierz istniejący model lub wpisz nowy
        </p>
      </div>
      <button class="add-new-btn" id="add-new-btn">+ Dodaj nowe mockupy</button>
      <input type="file" id="file-input" accept="image/png" multiple />
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Elements
        const fileInput = document.getElementById("file-input");
        const mockupGallery = document.getElementById("mockup-gallery");
        const loadingIndicator = document.getElementById("loading-indicator");
        const noMockups = document.getElementById("no-mockups");
        const addNewBtn = document.getElementById("add-new-btn");
        const existingMockups = document.getElementById("existing-mockups");
        const uploadIndicator = document.getElementById("upload-indicator");
        const modelInput = document.getElementById("mockup-model");

        // Click handler for add button
        addNewBtn.addEventListener("click", () => {
          fileInput.click();
        });

        // Available mockup list
        let mockupFiles = [];
        let mockupItems = [];

        // Function to initialize mockup gallery
        async function initializeMockupGallery() {
          try {
            // Show loading indicator
            loadingIndicator.style.display = "block";

            // Load available models
            await loadAvailableModels();

            // Fetch mockups from API
            const availableMockups = await fetchMockups();

            // Hide loading indicator
            loadingIndicator.style.display = "none";

            // Generate mockup manager interface
            generateMockupManager(availableMockups);
          } catch (error) {
            console.error("Error initializing mockup gallery:", error);
            loadingIndicator.textContent = "Błąd wczytywania mockupów.";
          }
        }

        // Load available models for the datalist
        async function loadAvailableModels() {
          try {
            const response = await fetch("/api/models");
            const data = await response.json();

            if (data.success) {
              const modelsList = document.getElementById("models-list");
              modelsList.innerHTML = "";

              data.models.forEach((model) => {
                const option = document.createElement("option");
                option.value = model;
                modelsList.appendChild(option);
              });
            }
          } catch (error) {
            console.error("Error loading models:", error);
          }
        }

        // Function to fetch mockups from API
        async function fetchMockups() {
          try {
            const response = await fetch("/api/mockups");
            const data = await response.json();

            if (data.success) {
              return data.mockups;
            } else {
              throw new Error(data.error || "Unknown error");
            }
          } catch (error) {
            console.error("Error fetching mockups:", error);
            return [];
          }
        }

        // Function to generate mockup manager interface
        function generateMockupManager(mockups) {
          mockupGallery.innerHTML = ""; // Clear gallery

          if (mockups.length === 0) {
            noMockups.style.display = "block";
            return;
          } else {
            noMockups.style.display = "none";
          }

          // Group mockups by model
          const mockupsByModel = {};
          mockups.forEach((mockup) => {
            const model = mockup.model || "Inne";
            if (!mockupsByModel[model]) {
              mockupsByModel[model] = [];
            }
            mockupsByModel[model].push(mockup);
          });

          // Sort mockups by ID within each model group
          Object.keys(mockupsByModel).forEach((model) => {
            mockupsByModel[model].sort((a, b) => a.id - b.id);
          });

          // Display mockups grouped by model
          Object.keys(mockupsByModel)
            .sort()
            .forEach((model) => {
              // Add model header
              const modelHeader = document.createElement("div");
              modelHeader.className = "model-header";
              modelHeader.textContent =
                model + ` (${mockupsByModel[model].length})`;
              mockupGallery.appendChild(modelHeader);

              // Add mockups for this model
              mockupsByModel[model].forEach((mockup) => {
                const itemHTML = `
          <div class="mockup-item" data-id="${mockup.id}" data-path="${mockup.path}">
            <div class="mockup-thumbnail">
              <img src="${mockup.path}" alt="Mockup ${mockup.id}" />
            </div>
            <div class="mockup-controls">
              <div class="mockup-model">${mockup.model}</div>
              <div class="mockup-actions">
                <button class="action-btn edit-model" title="Zmień model">📱</button>
                <button class="action-btn delete" title="Usuń mockup">×</button>
              </div>
            </div>
          </div>
        `;
                mockupGallery.innerHTML += itemHTML;
              });
            });

          // Assign listeners to newly generated elements
          setupMockupItemListeners();
        }

        // Function to handle clicks on mockup items
        function setupMockupItemListeners() {
          mockupItems = document.querySelectorAll(".mockup-item");

          mockupItems.forEach((item) => {
            // Delete button
            const deleteBtn = item.querySelector(".action-btn.delete");
            deleteBtn.addEventListener("click", async function (e) {
              e.stopPropagation();

              if (confirm("Czy na pewno chcesz usunąć ten mockup?")) {
                try {
                  const mockupId = item.getAttribute("data-id");

                  // Show loading indicator
                  uploadIndicator.style.display = "flex";
                  uploadIndicator.querySelector(
                    ".upload-indicator-text"
                  ).textContent = "Usuwanie mockupu...";

                  // Call API to delete mockup
                  const response = await fetch(`/api/mockups/${mockupId}`, {
                    method: "DELETE",
                  });

                  const result = await response.json();

                  // Hide loading indicator
                  uploadIndicator.style.display = "none";

                  if (result.success) {
                    // Remove item from DOM
                    item.remove();

                    // Check if all mockups were removed
                    if (
                      document.querySelectorAll(".mockup-item").length === 0
                    ) {
                      noMockups.style.display = "block";
                    }
                  } else {
                    alert(`Błąd: ${result.error}`);
                  }
                } catch (error) {
                  uploadIndicator.style.display = "none";
                  console.error("Error deleting mockup:", error);
                  alert("Wystąpił błąd podczas usuwania mockupu.");
                }
              }
            });

            // Edit model button
            const editModelBtn = item.querySelector(".action-btn.edit-model");
            if (editModelBtn) {
              editModelBtn.addEventListener("click", async function (e) {
                e.stopPropagation();

                const mockupId = item.getAttribute("data-id");
                const modelElement = item.querySelector(".mockup-model");
                const currentModel = modelElement
                  ? modelElement.textContent
                  : "Inne";

                const newModel = prompt(
                  "Wprowadź model telefonu:",
                  currentModel
                );

                if (newModel && newModel !== currentModel) {
                  try {
                    // Show loading indicator
                    uploadIndicator.style.display = "flex";
                    uploadIndicator.querySelector(
                      ".upload-indicator-text"
                    ).textContent = "Aktualizowanie modelu...";

                    // Call API to update model
                    const response = await fetch(
                      `/api/mockups/${mockupId}/model`,
                      {
                        method: "PUT",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ model: newModel }),
                      }
                    );

                    const result = await response.json();

                    // Hide loading indicator
                    uploadIndicator.style.display = "none";

                    if (result.success) {
                      // Refresh mockup gallery to reflect changes
                      initializeMockupGallery();
                      alert("Model zaktualizowany pomyślnie");
                    } else {
                      alert(`Błąd: ${result.error}`);
                    }
                  } catch (error) {
                    uploadIndicator.style.display = "none";
                    console.error("Error updating model:", error);
                    alert("Wystąpił błąd podczas aktualizacji modelu.");
                  }
                }
              });
            }

            // Click handler for thumbnail (select/deselect)
            const thumbnail = item.querySelector(".mockup-thumbnail");
            thumbnail.addEventListener("click", function () {
              item.classList.toggle("active");
            });
          });
        }

        // Initialize gallery on page load
        initializeMockupGallery();

        // File input change handler
        fileInput.addEventListener("change", handleFiles);

        // Drag & drop handlers
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          existingMockups.addEventListener(eventName, preventDefaults);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          existingMockups.addEventListener(eventName, () => {
            existingMockups.classList.add("dragover");
          });
        });

        ["dragleave", "drop"].forEach((eventName) => {
          existingMockups.addEventListener(eventName, () => {
            existingMockups.classList.remove("dragover");
          });
        });

        existingMockups.addEventListener("drop", (e) => {
          const dt = e.dataTransfer;
          const files = dt.files;
          handleFiles({ target: { files } });
        });

        // Function to handle uploaded files
        async function handleFiles(e) {
          const files = e.target.files;

          if (files.length === 0) {
            return;
          }

          // Check if all files are PNG
          let allPNG = true;
          for (let i = 0; i < files.length; i++) {
            if (!files[i].type.match("image/png")) {
              allPNG = false;
              break;
            }
          }

          if (!allPNG) {
            alert("Można wgrać tylko pliki PNG! Wybierz ponownie.");
            return;
          }

          // Get the model from the input - spaces are preserved
          let model = modelInput.value.trim();

          // If model is empty after trimming, use "Inne"
          if (!model) {
            model = "Inne";
          }

          console.log("Using model (before server processing):", model);

          // Show upload indicator
          uploadIndicator.style.display = "flex";

          try {
            // Determine next mockup number
            const existingMockups = await fetchMockups();
            let nextMockupNumber = 1;

            if (existingMockups.length > 0) {
              // Find the highest ID and add 1
              nextMockupNumber =
                Math.max(...existingMockups.map((m) => m.id)) + 1;
            }

            // Upload each file
            const uploadPromises = [];

            for (let i = 0; i < files.length; i++) {
              const formData = new FormData();
              formData.append("mockup", files[i]);
              formData.append("mockupNumber", nextMockupNumber + i);
              formData.append("mockupModel", model); // Send model with spaces intact
              // No longer sending mockupName field - we're only using model

              const uploadPromise = fetch("/api/upload/mockup", {
                method: "POST",
                body: formData,
              }).then((response) => response.json());

              uploadPromises.push(uploadPromise);
            }

            // Wait for all uploads to complete
            const results = await Promise.all(uploadPromises);

            // Hide upload indicator
            uploadIndicator.style.display = "none";

            // Check for errors
            const errors = results.filter((result) => !result.success);

            if (errors.length > 0) {
              alert(
                `Wystąpiły błędy podczas przesyłania plików: ${errors
                  .map((e) => e.error)
                  .join(", ")}`
              );
            } else {
              alert(
                `Pomyślnie dodano ${files.length} mockup${
                  files.length > 1 ? "ów" : ""
                }!`
              );
            }

            // Refresh mockup gallery
            initializeMockupGallery();

            // Reset file input and model field
            fileInput.value = "";
            modelInput.value = "";
          } catch (error) {
            console.error("Error uploading files:", error);
            uploadIndicator.style.display = "none";
            alert("Wystąpił błąd podczas przesyłania plików.");
            fileInput.value = "";
          }
        }
      });
    </script>
    <script src="./js/auth.js"></script>
  </body>
</html>
